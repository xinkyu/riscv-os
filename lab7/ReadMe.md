# å®éªŒä¸ƒï¼šæ—¥å¿—æ–‡ä»¶ç³»ç»Ÿ (Lab 7 Filesystem)

## ğŸ¯ å®éªŒç›®æ ‡

åœ¨æ­¤å‰å®Œæˆç³»ç»Ÿè°ƒç”¨ã€è¿›ç¨‹ç®¡ç†ä¸è®¾å¤‡é©±åŠ¨ä¹‹åï¼Œæœ¬å®éªŒèšç„¦äºâ€œè®©æ•°æ®å¯é ç€é™†â€ã€‚æ ¸å¿ƒç›®æ ‡åŒ…æ‹¬ï¼š

1. æ„å»ºåŸºäºä½å›¾çš„å—åˆ†é…å™¨ä¸ inode æ ‘ï¼Œæ”¯æŒæ™®é€šæ–‡ä»¶ä¸ç›®å½•æ“ä½œã€‚
2. æ­å»º `bio` ç¼“å†²åŒºç¼“å­˜ã€`sleeplock` ä¿æŠ¤ä»¥åŠå†™å‰æ—¥å¿—ï¼ˆWrite-Ahead Loggingï¼‰ã€‚
3. é€šè¿‡ `sys_open/close/read/write/link/unlink/mkdir/mknod/chdir` ç­‰ç³»ç»Ÿè°ƒç”¨å½¢æˆæœ€å°å¯ç”¨çš„ POSIX é£æ ¼æ¥å£ã€‚
4. è®¾è®¡å†…æ ¸è‡ªæµ‹ç”¨ä¾‹ï¼Œè¦†ç›–å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼šå»ºæ–‡ä»¶ â†’ å¹¶å‘è®¿é—® â†’ å´©æºƒæ¢å¤ â†’ æ€§èƒ½å‹æµ‹ã€‚

## ğŸ§± æ ¸å¿ƒæ¨¡å—

### 1. å—ä¸ inode ç®¡ç† (`kernel/fs.c`)
- **ä½å›¾æ‰«æ (`balloc/bfree`)**ï¼šéå† `BBLOCK`ï¼Œä»…åœ¨æ•°æ®åŒºèµ·å§‹å—ä¹‹åè¿›è¡Œåˆ†é…ï¼›é‡å¤é‡Šæ”¾ç«‹å³ `panic`ï¼Œé˜²å¾¡åŒé‡é‡Šæ”¾ã€‚
- **inode ç¼“å­˜ (`icache`)**ï¼š`sleeplock` å…¨ç¨‹ä¿æŠ¤ï¼Œ`iget/ilock/iupdate/itrunc` ç®¡ç†ç”Ÿå‘½å‘¨æœŸä¸è½ç›˜ã€‚
- **`bmap`**ï¼šæä¾› 12 ä¸ªç›´æ¥å— + 1 ä¸ªé—´æ¥å—ï¼Œæœ€å¤§æ–‡ä»¶å¤§å° `MAXFILE * BSIZE`ã€‚

### 2. å†™å‰æ—¥å¿— (Write-Ahead Logging, `kernel/log.c`)
- `begin_op/end_op` æ§åˆ¶äº‹åŠ¡æ•°é‡å¹¶é˜»æ­¢è¶…è¿‡ `LOGSIZE`ã€‚
- `log_write` ä»…åœ¨å—ç¬¬ä¸€æ¬¡è¿›å…¥æ—¥å¿—æ—¶ `bpin`ï¼Œé¿å…æ— é™å¢åŠ  `refcnt`ã€‚
- `install_trans` åœ¨å›æ”¾æ—¥å¿—åç«‹å³ `bunpin`ï¼Œç¡®ä¿ç¼“å†²åŒºæœ€ç»ˆå¯å›æ”¶ã€‚

### 3. ç³»ç»Ÿè°ƒç”¨åˆ°æ–‡ä»¶ç³»ç»Ÿæ ˆ (`kernel/sysfile.c`, `kernel/file.c`)
- å®ç° `sys_open/close/read/write/link/unlink/mkdir/mknod/chdir/fstat` ç­‰æ¥å£ï¼Œè´¯é€š VFS â†’ inode â†’ å—ç¼“å­˜ã€‚
- `filewrite` ä½¿ç”¨â€œåˆ†å— + äº‹åŠ¡â€ç­–ç•¥ï¼Œä¸€æ¬¡å†™å…¥ä¸ä¼šæ’‘çˆ†æ—¥å¿—ï¼Œä¿è¯åŸå­æ€§ä¸æ€§èƒ½çš„å¹³è¡¡ã€‚

### 4. è‡ªå®šä¹‰æµ‹è¯•æ¡†æ¶ (`kernel/test.c`)
- **FS Test 1 â€“ Integrity**ï¼šåˆ›å»º â†’ å†™å…¥ â†’ è¯»å– â†’ unlinkï¼ŒéªŒè¯åŸºç¡€è¯»å†™ä¸ç›®å½•æ“ä½œã€‚
- **FS Test 2 â€“ Concurrent Access**ï¼šå¤šä¸ªè¿›ç¨‹ç«äº‰åŒä¸€ç›®å½•ï¼Œæ£€éªŒæ—¥å¿—ä¸²è¡ŒåŒ–ä¸ `bio` çš„æ­£ç¡®æ€§ã€‚
- **FS Test 3 â€“ Crash Recovery**ï¼šæ‰‹åŠ¨è°ƒç”¨ `initlog()` æ¨¡æ‹Ÿé‡å¯ï¼Œç¡®ä¿æ—¥å¿—é‡æ”¾èƒ½æ¢å¤ä¸€è‡´çŠ¶æ€ã€‚
- **FS Test 4 â€“ Performance**ï¼šç”Ÿæˆ 200 ä¸ªå°æ–‡ä»¶ä¸ 4MB å¤§æ–‡ä»¶ï¼Œè¾“å‡ºè€—æ—¶ã€ç¼“å­˜å‘½ä¸­ã€ç£ç›˜ IO ç»Ÿè®¡ã€‚

## âœ… è¿è¡Œä¸éªŒè¯

```bash
# æ¸…ç†æ—§æ„å»º
make clean

# ç¼–è¯‘å¹¶è¿è¡Œæ‰€æœ‰å†…æ ¸å†…æµ‹è¯•ï¼ˆLab6 + Lab7ï¼‰
make run
```

QEMU æ§åˆ¶å°ä¼šæ‰“å°æ¯ä¸€é˜¶æ®µçš„è¯¦ç»†æ—¥å¿—ï¼›å‡ºç° `===== All Labs Complete =====` å³ä»£è¡¨æ‰€æœ‰å®éªŒé€šè¿‡ã€‚

## ğŸ“ˆ å®éªŒæˆæœæ‘˜è¦
- å®ç° xv6 é£æ ¼çš„æ—¥å¿—æ–‡ä»¶ç³»ç»Ÿï¼Œæä¾›ç¨³å®šçš„ POSIX åŸºç¡€æ“ä½œé›†ã€‚
- ä¿®å¤ä½å›¾åˆ†é…ä¸æ—¥å¿— pin/unpin çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œé•¿æ—¶é—´å‹åŠ›æµ‹è¯•ä¸å† panicã€‚
- å†…ç½®æµ‹è¯•è¦†ç›–åŠŸèƒ½ã€å¹¶å‘ã€å´©æºƒæ¢å¤ä¸æ€§èƒ½åœºæ™¯ï¼Œä¾¿äºå›å½’ä¸æ‰©å±•ã€‚

> æƒ³æ·±å…¥äº†è§£ï¼Œå¯é‡ç‚¹é˜…è¯» `kernel/fs.c`, `kernel/log.c`, `kernel/bio.c`, `kernel/sysfile.c` å››ä¸ªæ–‡ä»¶ï¼Œå®ƒä»¬æ„æˆäº† Lab7 çš„æ ¸å¿ƒã€‚