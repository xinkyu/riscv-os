# 从零构建操作系统

本专案是武汉大学《操作系统实践A》课程的成果。
目标是从零开始，基于 RISC-V 架构，逐步实现一个迷你的操作系统核心。

## 目前完成进度

* **实验 1**: RISC-V 引导与裸机启动
    * 实现了基本的汇编语言启动程序。
    * 建立了 C 语言执行环境并设置了堆栈。
    * 实现了简化的 UART 驱动，可在 QEMU 中输出 "Hello OS"。

* **实验 2**: 内核 printf 与清屏功能实现
    * 实现了支持 `%d`、`%x`、`%s`、`%c`、`%%` 的 `printf` 函数。
    * 实现了基于 ANSI 转义序列的清屏功能。

* **实验 3**: 页表与内存管理
    * 实现了一个页式物理内存分配器 (`kalloc.c`)，使用空闲链表管理物理页。
    * 实现了 RISC-V Sv39 页表管理机制，包括页表的创建、遍历 (`walk`) 和地址映射 (`mappages`)。
    * 成功激活了 MMU，使内核在虚拟内存环境下稳定运行，并实现了内核代码段、数据段和设备内存的正确映射。

* **实验 4**: 中断处理与时钟管理
    * 实现了 Supervisor 模式下的中断入口 (`kernelvec.S`)，用于保存和恢复包含所有通用寄存器的上下文。
    * 建立了 C 语言中断处理框架 (`trap.c`)，能够根据 `scause` 寄存器分发中断（如时钟中断）和异常。
    * 成功通过 SBI 接口初始化并启用了时钟中断，内核现在可以周期性地响应硬件定时器事件。

* **实验 5**: 进程管理与调度
    * 实现了进程控制块 (`struct proc`) 和全局进程表，包含进程状态、内核栈、上下文等核心信息。
    * 实现了汇编级的上下文切换函数 `swtch`，用于在进程调度器和进程之间切换 CPU 状态。
    * 实现了基于时钟中断的协作式轮转（Round-Robin）调度器 (`scheduler`)。
    * 实现了 `sleep`/`wakeup` 同步原语，支持进程的阻塞与唤醒。

* **实验 6**: 系统调用 (System Calls)
    * **基础框架**: 建立了 `ecall` 陷阱处理机制 (`scause == 8`)，实现了系统调用分发器 `syscall` 和参数提取函数 (`argint`, `argaddr`, `argstr`)。
    * **进程管理**: 实现了核心的进程管理系统调用：
        * `sys_fork`: 复制当前进程（包含 Trapframe 和内存），创建子进程。
        * `sys_exit`: 终止当前进程，释放资源并唤醒父进程。
        * `sys_wait`: 等待子进程退出并回收其僵尸状态。
        * `sys_getpid`: 获取当前进程 ID。
    * **文件操作**: 实现了基础的文件 I/O 系统调用接口：
        * `sys_write`: 支持向标准输出 (fd 1) 和错误输出 (fd 2) 写入数据。
        * `sys_read`, `sys_open`, `sys_close`: 实现了基础接口桩代码，为后续文件系统实验做好了准备。
    * **系统安全**: 引入了 `validate_addr` 机制，在内核访问用户指针前检查页表映射有效性，防止恶意指针导致内核崩溃。
    * **稳定性修复**: 解决了中断嵌套导致的上下文（`sepc`, `sstatus`）破坏问题，确保了系统调用返回的可靠性。
    * **功能增强**: `printf` 增加了对长整数 (`%l`) 和指针 (`%p`) 的支持，优化了调试输出。

* **实验 7**: 日志文件系统 (Filesystem with WAL)
    * **块与 inode 管理**: 基于位图的 `balloc/bfree`、`bmap`、`itrunc` 组合，支撑普通文件与目录的生命周期。
    * **写前日志**: `begin_op/end_op`、`log_write`、`install_trans` 构成的 WAL 机制保证崩溃后一致性，修复了重复 pin 导致的缓冲区泄漏。
    * **系统调用栈**: 完成 `open/close/read/write/link/unlink/mkdir/mknod/chdir/fstat` 等系统调用，配合 `file.c` 的分块写入逻辑确保单次写入不会撑爆日志。
    * **内核自测**: `kernel/test.c` 覆盖完整生命周期（完整性、并发、崩溃恢复、性能），`make run` 可一次性验证 Lab6+Lab7。

## 开发环境

* **操作系统**: Ubuntu 22.04 LTS 
* **工具链**: riscv64-unknown-elf-gcc 
* **模拟器**: QEMU (qemu-system-riscv64) 

## 编译与执行

1.  **编译内核**：
    ```bash
    make
    ```

2.  **在 QEMU 中执行**：
    ```bash
    make run
    ```